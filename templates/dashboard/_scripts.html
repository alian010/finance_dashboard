<script>
  /* =========================
     0) DEBUG HELPERS
  ========================== */
  function dbg(...args) { console.log("[DASHBOARD]", ...args); }
  window.addEventListener("error", (e) => {
    console.error("[DASHBOARD ERROR]", e.message, e.error);
  });

  /* =========================
     1) DOM REFERENCES
  ========================== */
  const userLine = document.getElementById("userLine");

  // KPI (NEW)
  const kpiIncome  = document.getElementById("kpiIncome");
  const kpiExpense = document.getElementById("kpiExpense");
  const kpiNet     = document.getElementById("kpiNet");

  // Table
  const txBody   = document.getElementById("txBody");
  const pageNoEl = document.getElementById("pageNo");
  const pageMeta = document.getElementById("pageMeta");

  // Charts (NEW)
  const expenseHint = document.getElementById("expenseHint");
  const incomeHint  = document.getElementById("incomeHint");

  const modal     = document.getElementById("modal");
  const addStatus = document.getElementById("addStatus");
  const addOutput = document.getElementById("addOutput");

  const editModal  = document.getElementById("editModal");
  const editStatus = document.getElementById("editStatus");
  const editOutput = document.getElementById("editOutput");

  // Category selects
  const addCategorySelect  = document.getElementById("category");
  const editCategorySelect = document.getElementById("editCategory");

  // txn type selects (NEW)  ✅ তোমার HTML এ এই দুইটা select থাকতে হবে
  const addTxnTypeSelect  = document.getElementById("txnType");
  const editTxnTypeSelect = document.getElementById("editTxnType");

  /* =========================
     2) STATE
  ========================== */
  let page = 1;
  let pageSize = 20;

  let expenseChart = null;
  let incomeChart  = null;

  /* =========================
     3) AUTH HELPERS
  ========================== */
  function getAccess() { return localStorage.getItem("access_token"); }

  function authHeaders() {
    const token = getAccess();
    return token ? { "Authorization": "Bearer " + token } : {};
  }

  function money(v) {
    const n = Number(v);
    if (!Number.isFinite(n)) return "—";
    return "৳ " + n.toFixed(2);
  }

  function ensureAuthOrRedirect() {
    if (!getAccess()) {
      dbg("No access token -> redirect login");
      window.location.href = "/api/auth/login/";
      return false;
    }
    return true;
  }

  /* =========================
     4) API HELPERS
  ========================== */
  async function apiGet(path) {
    dbg("GET", path);
    const res = await fetch(path, { headers: { ...authHeaders() } });
    const text = await res.text();
    let data = {};
    try { data = text ? JSON.parse(text) : {}; }
    catch { data = { raw: text }; }
    return { ok: res.ok, status: res.status, data };
  }

  async function apiPost(path, body) {
    dbg("POST", path, body);
    const res = await fetch(path, {
      method: "POST",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify(body),
    });
    const text = await res.text();
    let data = {};
    try { data = text ? JSON.parse(text) : {}; }
    catch { data = { raw: text }; }
    return { ok: res.ok, status: res.status, data };
  }

  async function apiPatch(path, body) {
    dbg("PATCH", path, body);
    const res = await fetch(path, {
      method: "PATCH",
      headers: { "Content-Type": "application/json", ...authHeaders() },
      body: JSON.stringify(body),
    });
    const text = await res.text();
    let data = {};
    try { data = text ? JSON.parse(text) : {}; }
    catch { data = { raw: text }; }
    return { ok: res.ok, status: res.status, data };
  }

  async function apiDelete(path) {
    dbg("DELETE", path);
    const res = await fetch(path, { method: "DELETE", headers: { ...authHeaders() } });
    const text = await res.text();
    let data = {};
    try { data = text ? JSON.parse(text) : {}; }
    catch { data = { raw: text }; }
    return { ok: res.ok, status: res.status, data };
  }

  /* =========================
     5) LOAD CATEGORIES (ADMIN MANAGED)
     ✅ IMPORTANT: value MUST be c.id (PK)
  ========================== */
  async function loadCategories() {
    const { ok, status, data } = await apiGet("/api/categories/");
    if (!ok) {
      dbg("Categories load failed", status, data);
      return;
    }

    const list = Array.isArray(data) ? data : (data.results || []);

    const fill = (sel) => {
      if (!sel) return;
      sel.innerHTML = "";
      sel.insertAdjacentHTML("beforeend", `<option value="">Select category</option>`);
      for (const c of list) {
        sel.insertAdjacentHTML("beforeend", `<option value="${c.id}">${c.name}</option>`);
      }
    };

    fill(addCategorySelect);
    fill(editCategorySelect);
  }

  /* =========================
     6) RENDER TRANSACTIONS TABLE
  ========================== */
  function renderTransactions(list) {
    txBody.innerHTML = "";
    if (!Array.isArray(list) || list.length === 0) {
      txBody.innerHTML = `
        <tr class="border-b border-slate-900">
          <td class="py-4 text-slate-500" colspan="6">No transactions found.</td>
        </tr>
      `;
      return;
    }

    for (const t of list) {
      const note = (t.note || "").replaceAll("<", "&lt;");
      const catLabel = t.category_name || t.category_code || "—";
      const typeLabel = t.txn_type || "—";

      txBody.insertAdjacentHTML("beforeend", `
        <tr class="border-b border-slate-900 hover:bg-slate-900/30 transition">
          <td class="py-3">${t.date || "—"}</td>
          <td class="py-3">${typeLabel}</td>
          <td class="py-3">${catLabel}</td>
          <td class="py-3 text-slate-300">${note || "<span class='text-slate-600'>—</span>"}</td>
          <td class="py-3 text-right font-medium">${money(t.amount)}</td>
          <td class="py-3 text-right">
            <div class="flex justify-end gap-2">
              <button
                class="rounded-lg border border-slate-800 px-3 py-1.5 text-xs hover:bg-slate-900 transition"
                onclick='openEditModal(${JSON.stringify(t)})'>
                Edit
              </button>
              <button
                class="rounded-lg border border-red-900/60 px-3 py-1.5 text-xs hover:bg-red-950/40 transition"
                onclick="deleteTransaction(${t.id})">
                Delete
              </button>
            </div>
          </td>
        </tr>
      `);
    }
  }

  /* =========================
     7) CHART RENDER (2 PIE)
  ========================== */
  function buildPieData(breakdownObj) {
    const labels = [];
    const values = [];
    for (const [k, v] of Object.entries(breakdownObj || {})) {
      labels.push(k);
      values.push(Number(v) || 0);
    }
    return { labels, values };
  }

  function renderPieChart({ canvasId, hintEl, chartRef, breakdown }) {
    if (!window.Chart) {
      if (hintEl) hintEl.textContent = "Chart.js not loaded. Check CDN / network.";
      return null;
    }

    const { labels, values } = buildPieData(breakdown);

    if (hintEl) {
      hintEl.textContent = labels.length
        ? "Updates instantly when you add a transaction."
        : "No data for this month yet.";
    }

    const ctx = document.getElementById(canvasId);
    if (!ctx) return null;

    if (chartRef) chartRef.destroy();

    return new Chart(ctx, {
      type: "pie",
      data: { labels, datasets: [{ data: values }] },
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });
  }

  /* =========================
     8) LOADERS (API DATA)
  ========================== */
  async function loadMe() {
    const { ok, status, data } = await apiGet("/api/auth/me/");
    if (!ok) {
      userLine.textContent = status === 401 ? "Not logged in" : "User load failed";
      if (status === 401) {
        localStorage.removeItem("access_token");
        localStorage.removeItem("refresh_token");
        window.location.href = "/api/auth/login/";
      }
      return;
    }
    userLine.textContent = `${data.username} • ${data.email || ""}`;
  }

  async function loadSummary() {
    const { ok, status, data } = await apiGet("/api/summary/");
    if (!ok) {
      kpiIncome.textContent  = "—";
      kpiExpense.textContent = "—";
      kpiNet.textContent     = "—";

      expenseChart = renderPieChart({
        canvasId: "expenseChart",
        hintEl: expenseHint,
        chartRef: expenseChart,
        breakdown: {}
      });

      incomeChart = renderPieChart({
        canvasId: "incomeChart",
        hintEl: incomeHint,
        chartRef: incomeChart,
        breakdown: {}
      });

      if (expenseHint) {
        expenseHint.textContent = status === 404
          ? "Summary endpoint not found yet (/api/summary/)."
          : "Failed to load summary (check console).";
      }
      return;
    }

    // ✅ expects new SummaryView response
    kpiIncome.textContent  = money(data.income_total);
    kpiExpense.textContent = money(data.expense_total);
    kpiNet.textContent     = money(data.net);

    expenseChart = renderPieChart({
      canvasId: "expenseChart",
      hintEl: expenseHint,
      chartRef: expenseChart,
      breakdown: data.expense_breakdown
    });

    incomeChart = renderPieChart({
      canvasId: "incomeChart",
      hintEl: incomeHint,
      chartRef: incomeChart,
      breakdown: data.income_breakdown
    });
  }

  async function loadTransactions() {
    const url = `/api/transactions/?page=${page}&page_size=${pageSize}`;
    const { ok, status, data } = await apiGet(url);

    if (!ok) {
      renderTransactions([]);
      pageMeta.textContent = status === 404
        ? "Transactions endpoint not found yet (/api/transactions/)."
        : "Failed to load (check console).";
      return;
    }

    renderTransactions(data.results || []);
    pageMeta.textContent = `Total ${data.count ?? "—"}`;
  }

  async function refreshAll() {
    if (!ensureAuthOrRedirect()) return;
    await Promise.all([loadMe(), loadCategories(), loadSummary(), loadTransactions()]);
  }

  /* =========================
     9) MODALS
  ========================== */
  function openModal() {
    modal.classList.remove("hidden");
    addStatus.textContent = "";
    addOutput.textContent = "";
    document.getElementById("date").value = new Date().toISOString().slice(0, 10);

    // default txn type
    if (addTxnTypeSelect && !addTxnTypeSelect.value) addTxnTypeSelect.value = "EXPENSE";
  }
  function closeModal() { modal.classList.add("hidden"); }

  function openEditModal(t) {
    editStatus.textContent = "";
    editOutput.textContent = "";

    document.getElementById("editId").value = t.id;
    document.getElementById("editAmount").value = t.amount ?? "";
    document.getElementById("editDate").value = t.date ?? "";

    // ✅ backend expects category PK
    document.getElementById("editCategory").value = t.category ?? "";

    // ✅ txn_type edit
    if (editTxnTypeSelect) editTxnTypeSelect.value = t.txn_type || "EXPENSE";

    document.getElementById("editNote").value = t.note ?? "";
    editModal.classList.remove("hidden");
  }
  function closeEditModal() { editModal.classList.add("hidden"); }
  window.openEditModal = openEditModal;

  /* =========================
     10) EVENTS
  ========================== */
  document.getElementById("btnRefresh")?.addEventListener("click", refreshAll);
  document.getElementById("btnOpenAdd")?.addEventListener("click", openModal);

  document.getElementById("btnCloseModal")?.addEventListener("click", closeModal);
  modal?.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

  document.getElementById("btnCloseEditModal")?.addEventListener("click", closeEditModal);
  editModal?.addEventListener("click", (e) => { if (e.target === editModal) closeEditModal(); });

  document.getElementById("btnPrev")?.addEventListener("click", async () => {
    if (page > 1) page -= 1;
    pageNoEl.textContent = String(page);
    await loadTransactions();
  });

  document.getElementById("btnNext")?.addEventListener("click", async () => {
    page += 1;
    pageNoEl.textContent = String(page);
    await loadTransactions();
  });

  document.getElementById("pageSize")?.addEventListener("change", async (e) => {
    pageSize = Number(e.target.value) || 20;
    page = 1;
    pageNoEl.textContent = "1";
    await loadTransactions();
  });

  // ADD TRANSACTION ✅ includes txn_type
  document.getElementById("addForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    addStatus.textContent = "Saving…";

    const payload = {
      txn_type: (addTxnTypeSelect?.value || "EXPENSE"),
      amount: document.getElementById("amount").value,
      date: document.getElementById("date").value,
      category: Number(document.getElementById("category").value), // ✅ PK
      note: document.getElementById("note").value,
    };

    const { ok, data } = await apiPost("/api/transactions/", payload);
    if (!ok) {
      addStatus.textContent = "Validation failed / API error.";
      addOutput.textContent = JSON.stringify(data, null, 2);
      return;
    }

    addStatus.textContent = "Saved ✅ Refreshing…";
    addOutput.textContent = JSON.stringify(data, null, 2);
    await Promise.all([loadSummary(), loadTransactions()]);
    setTimeout(closeModal, 250);
  });

  // EDIT TRANSACTION ✅ includes txn_type
  document.getElementById("editForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    editStatus.textContent = "Updating…";

    const id = document.getElementById("editId").value;
    const payload = {
      txn_type: (editTxnTypeSelect?.value || "EXPENSE"),
      amount: document.getElementById("editAmount").value,
      date: document.getElementById("editDate").value,
      category: Number(document.getElementById("editCategory").value), // ✅ PK
      note: document.getElementById("editNote").value,
    };

    const { ok, data } = await apiPatch(`/api/transactions/${id}/`, payload);
    if (!ok) {
      editStatus.textContent = "Update failed.";
      editOutput.textContent = JSON.stringify(data, null, 2);
      return;
    }

    editStatus.textContent = "Updated ✅ Refreshing…";
    editOutput.textContent = JSON.stringify(data, null, 2);
    await Promise.all([loadSummary(), loadTransactions()]);
    setTimeout(closeEditModal, 250);
  });

  // DELETE (SOFT)
  window.deleteTransaction = async function (id) {
    const confirmed = confirm("Are you sure you want to delete this transaction?");
    if (!confirmed) return;

    const { ok, status, data } = await apiDelete(`/api/transactions/${id}/`);
    if (!ok) {
      alert("Delete failed: " + (data?.detail || `Status ${status}`));
      return;
    }
    await Promise.all([loadSummary(), loadTransactions()]);
  };

  /* =========================
     11) INIT
  ========================== */
  dbg("Dashboard script loaded ✅");
  if (ensureAuthOrRedirect()) refreshAll();
</script>
