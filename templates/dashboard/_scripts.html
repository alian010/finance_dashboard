<script>
	// ====== DEBUG HELPERS ======
	function dbg(...args) { console.log("[DASHBOARD]", ...args); }
	window.addEventListener("error", (e) => {
		console.error("[DASHBOARD ERROR]", e.message, e.error);
	});

	// ====== DOM ======
	const userLine = document.getElementById("userLine");
	const kpiTotal = document.getElementById("kpiTotal");
	const kpiTrend = document.getElementById("kpiTrend");
	const kpiTopCat = document.getElementById("kpiTopCat");
	const txBody = document.getElementById("txBody");
	const pageNoEl = document.getElementById("pageNo");
	const pageMeta = document.getElementById("pageMeta");
	const chartHint = document.getElementById("chartHint");

	const modal = document.getElementById("modal");
	const addStatus = document.getElementById("addStatus");
	const addOutput = document.getElementById("addOutput");

	const editModal = document.getElementById("editModal");
	const editStatus = document.getElementById("editStatus");
	const editOutput = document.getElementById("editOutput");

	let page = 1;
	let pageSize = 20;
	let chart = null;

	// ====== AUTH ======
	function getAccess() { return localStorage.getItem("access_token"); }
	function authHeaders() {
		const token = getAccess();
		return token ? { "Authorization": "Bearer " + token } : {};
	}

	function money(v) {
		if (v === null || v === undefined) return "—";
		return "৳ " + String(v);
	}

	function ensureAuthOrRedirect() {
		if (!getAccess()) {
			dbg("No access token -> redirect login");
			window.location.href = "/api/auth/login/";
			return false;
		}
		return true;
	}

	// ====== API ======
	async function apiGet(path) {
		dbg("GET", path);
		const res = await fetch(path, { headers: { ...authHeaders() } });
		const text = await res.text();
		let data = {};
		try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
		dbg("GET result", path, res.status, data);
		return { ok: res.ok, status: res.status, data };
	}

	async function apiPost(path, body) {
		dbg("POST", path, body);
		const res = await fetch(path, {
			method: "POST",
			headers: { "Content-Type": "application/json", ...authHeaders() },
			body: JSON.stringify(body),
		});
		const text = await res.text();
		let data = {};
		try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
		dbg("POST result", path, res.status, data);
		return { ok: res.ok, status: res.status, data };
	}

	async function apiPatch(path, body) {
		dbg("PATCH", path, body);
		const res = await fetch(path, {
			method: "PATCH",
			headers: { "Content-Type": "application/json", ...authHeaders() },
			body: JSON.stringify(body),
		});
		const text = await res.text();
		let data = {};
		try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
		dbg("PATCH result", path, res.status, data);
		return { ok: res.ok, status: res.status, data };
	}

	async function apiDelete(path) {
		dbg("DELETE", path);
		const res = await fetch(path, { method: "DELETE", headers: { ...authHeaders() } });
		const text = await res.text();
		let data = {};
		try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
		dbg("DELETE result", path, res.status, data);
		return { ok: res.ok, status: res.status, data };
	}

	// ====== RENDER ======
	function renderTransactions(list) {
		txBody.innerHTML = "";
		if (!Array.isArray(list) || list.length === 0) {
			txBody.innerHTML = `
        <tr class="border-b border-slate-900">
          <td class="py-4 text-slate-500" colspan="5">No transactions found.</td>
        </tr>
      `;
			return;
		}

		for (const t of list) {
			const note = (t.note || "").replaceAll("<", "&lt;");
			txBody.insertAdjacentHTML("beforeend", `
        <tr class="border-b border-slate-900 hover:bg-slate-900/30 transition">
          <td class="py-3">${t.date || "—"}</td>
          <td class="py-3">${t.category || "—"}</td>
          <td class="py-3 text-slate-300">${note || "<span class='text-slate-600'>—</span>"}</td>
          <td class="py-3 text-right font-medium">${money(t.amount)}</td>
          <td class="py-3 text-right">
            <div class="flex justify-end gap-2">
              <button
                class="rounded-lg border border-slate-800 px-3 py-1.5 text-xs hover:bg-slate-900 transition"
                onclick='openEditModal(${JSON.stringify(t)})'>
                Edit
              </button>
              <button
                class="rounded-lg border border-red-900/60 px-3 py-1.5 text-xs hover:bg-red-950/40 transition"
                onclick="deleteTransaction(${t.id})">
                Delete
              </button>
            </div>
          </td>
        </tr>
      `);
		}
	}

	function getTopCategory(breakdown) {
		if (!breakdown || typeof breakdown !== "object") return "—";
		let bestKey = null;
		let bestVal = -1;
		for (const [k, v] of Object.entries(breakdown)) {
			const num = Number(v);
			if (!Number.isNaN(num) && num > bestVal) {
				bestVal = num;
				bestKey = k;
			}
		}
		return bestKey || "—";
	}

	function renderChart(breakdown) {
		if (!window.Chart) {
			chartHint.textContent = "Chart.js not loaded. Check CDN / network.";
			return;
		}

		const labels = [];
		const values = [];
		if (breakdown && typeof breakdown === "object") {
			for (const [k, v] of Object.entries(breakdown)) {
				labels.push(k);
				values.push(Number(v));
			}
		}

		chartHint.textContent = labels.length === 0
			? "No data for this month yet. Add a transaction to see the chart."
			: "Updates instantly when you add a transaction.";

		const ctx = document.getElementById("categoryChart");
		if (chart) chart.destroy();

		chart = new Chart(ctx, {
			type: "pie",
			data: { labels, datasets: [{ data: values }] },
			options: {
				responsive: true,
				plugins: { legend: { position: "bottom", labels: { color: "#cbd5e1" } } }
			}
		});
	}

	// ====== LOADERS ======
	async function loadMe() {
		const { ok, status, data } = await apiGet("/api/auth/me/");
		if (!ok) {
			userLine.textContent = status === 401 ? "Not logged in" : "User load failed";
			if (status === 401) {
				localStorage.removeItem("access_token");
				localStorage.removeItem("refresh_token");
				window.location.href = "/api/auth/login/";
			}
			return;
		}
		userLine.textContent = `${data.username} • ${data.email || ""}`;
	}

	async function loadSummary() {
		const { ok, status, data } = await apiGet("/api/summary/");
		if (!ok) {
			kpiTotal.textContent = "—";
			kpiTrend.textContent = "—";
			kpiTopCat.textContent = "—";
			renderChart({});
			chartHint.textContent = status === 404
				? "Summary endpoint not found yet (/api/summary/)."
				: "Failed to load summary (check console).";
			return;
		}

		kpiTotal.textContent = money(data.current_month_total);
		kpiTrend.textContent = (typeof data.trend_percent === "number") ? data.trend_percent.toFixed(1) + "%" : "—";
		kpiTopCat.textContent = getTopCategory(data.category_breakdown);
		renderChart(data.category_breakdown);
	}

	async function loadTransactions() {
		const url = `/api/transactions/?page=${page}&page_size=${pageSize}`;
		const { ok, status, data } = await apiGet(url);

		if (!ok) {
			renderTransactions([]);
			pageMeta.textContent = status === 404
				? "Transactions endpoint not found yet (/api/transactions/)."
				: "Failed to load (check console).";
			return;
		}

		renderTransactions(data.results || []);
		pageMeta.textContent = `Total ${data.count ?? "—"}`;
	}

	async function refreshAll() {
		if (!ensureAuthOrRedirect()) return;
		await Promise.all([loadMe(), loadSummary(), loadTransactions()]);
	}

	// ====== MODALS ======
	function openModal() {
		modal.classList.remove("hidden");
		addStatus.textContent = "";
		addOutput.textContent = "";
		const d = new Date().toISOString().slice(0, 10);
		document.getElementById("date").value = d;
	}
	function closeModal() { modal.classList.add("hidden"); }

	function openEditModal(t) {
		editStatus.textContent = "";
		editOutput.textContent = "";
		document.getElementById("editId").value = t.id;
		document.getElementById("editAmount").value = t.amount ?? "";
		document.getElementById("editDate").value = t.date ?? "";
		document.getElementById("editCategory").value = t.category ?? "OTHER";
		document.getElementById("editNote").value = t.note ?? "";
		editModal.classList.remove("hidden");
	}
	function closeEditModal() { editModal.classList.add("hidden"); }

	// Expose to inline onclick
	window.openEditModal = openEditModal;

	// ====== EVENTS ======
	document.getElementById("btnLogout")?.addEventListener("click", () => {
		localStorage.removeItem("access_token");
		localStorage.removeItem("refresh_token");
		window.location.href = "/api/auth/login/";
	});

	document.getElementById("btnRefresh")?.addEventListener("click", refreshAll);
	document.getElementById("btnOpenAdd")?.addEventListener("click", openModal);

	document.getElementById("btnCloseModal")?.addEventListener("click", closeModal);
	modal?.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

	document.getElementById("btnCloseEditModal")?.addEventListener("click", closeEditModal);
	editModal?.addEventListener("click", (e) => { if (e.target === editModal) closeEditModal(); });

	document.getElementById("btnPrev")?.addEventListener("click", async () => {
		if (page > 1) page -= 1;
		pageNoEl.textContent = String(page);
		await loadTransactions();
	});

	document.getElementById("btnNext")?.addEventListener("click", async () => {
		page += 1;
		pageNoEl.textContent = String(page);
		await loadTransactions();
	});

	document.getElementById("pageSize")?.addEventListener("change", async (e) => {
		pageSize = Number(e.target.value) || 20;
		page = 1;
		pageNoEl.textContent = "1";
		await loadTransactions();
	});

	document.getElementById("addForm")?.addEventListener("submit", async (e) => {
		e.preventDefault();
		addStatus.textContent = "Saving…";

		const payload = {
			amount: document.getElementById("amount").value,
			date: document.getElementById("date").value,
			category: document.getElementById("category").value,
			note: document.getElementById("note").value,
		};

		const { ok, data } = await apiPost("/api/transactions/", payload);
		if (!ok) {
			addStatus.textContent = "Validation failed / API error (check console).";
			addOutput.textContent = JSON.stringify(data, null, 2);
			return;
		}

		addStatus.textContent = "Saved ✅ Refreshing…";
		addOutput.textContent = JSON.stringify(data, null, 2);
		await Promise.all([loadSummary(), loadTransactions()]);
		setTimeout(closeModal, 250);
	});

	document.getElementById("editForm")?.addEventListener("submit", async (e) => {
		e.preventDefault();
		editStatus.textContent = "Updating…";

		const id = document.getElementById("editId").value;
		const payload = {
			amount: document.getElementById("editAmount").value,
			date: document.getElementById("editDate").value,
			category: document.getElementById("editCategory").value,
			note: document.getElementById("editNote").value,
		};

		const { ok, data } = await apiPatch(`/api/transactions/${id}/`, payload);
		if (!ok) {
			editStatus.textContent = "Update failed (check console).";
			editOutput.textContent = JSON.stringify(data, null, 2);
			return;
		}

		editStatus.textContent = "Updated ✅ Refreshing…";
		editOutput.textContent = JSON.stringify(data, null, 2);
		await Promise.all([loadSummary(), loadTransactions()]);
		setTimeout(closeEditModal, 250);
	});

	window.deleteTransaction = async function (id) {
		const confirmed = confirm("Are you sure you want to delete this transaction?");
		if (!confirmed) return;

		const { ok, status, data } = await apiDelete(`/api/transactions/${id}/`);
		if (!ok) {
			alert("Delete failed: " + (data?.detail || `Status ${status}`));
			return;
		}
		await Promise.all([loadSummary(), loadTransactions()]);
	};

	// ====== INIT ======
	dbg("Dashboard script loaded ✅");
	if (ensureAuthOrRedirect()) {
		refreshAll();
	}
</script>